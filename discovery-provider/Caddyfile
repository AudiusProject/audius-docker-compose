# Define a snippet for common reverse proxy configuration
(common) {
  reverse_proxy /comms* comms:8925
  reverse_proxy /healthz* healthz
  route /dashboard* {
      redir /dashboard /dashboard/ 308
      uri strip_prefix /dashboard
      root * /dashboard-dist
      file_server
  }
  reverse_proxy backend:5000
}

# Use the snippet for port 80 and 443
{$audius_discprov_url}:80, {$audius_discprov_url}:443 {
  {$CADDY_TLS}
  encode zstd gzip
  import common
}

# Use the snippet for port 5000, allowing SPs to handle SSL downstream in their load balancer
{$audius_discprov_url}:5000 {
  auto_https off
  import common
}
